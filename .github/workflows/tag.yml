name: Tag Creator
on:
  issues:
    types: [opened]
jobs:
  bumpversion:
    if: >-
      (
        startsWith( github.event.issue.title, '[bumpversion:major]' ) ||
        startsWith( github.event.issue.title, '[bumpversion:minor]' ) ||
        startsWith( github.event.issue.title, '[bumpversion:patch]' )
      ) && (
        github.event.issue.user.login == 'lukasheinrich' ||
        github.event.issue.user.login == 'matthewfeickert' ||
        github.event.issue.user.login == 'kratsg'
      )
    env:
      IS_MAJOR: >-
          ${{ startsWith( github.event.issue.title, '[bumpversion:major]' ) }}
      IS_MINOR: >-
          ${{ startsWith( github.event.issue.title, '[bumpversion:minor]' ) }}
      IS_PATCH: >-
          ${{ startsWith( github.event.issue.title, '[bumpversion:patch]' ) }}
    runs-on: ubuntu-latest
    steps:
    - name: determine part
      run: |
        if [ $IS_MAJOR == 'true' ]
        then
          echo "::set-env name=BV_PART::major"
        elif [ $IS_MINOR == 'true' ]
        then
          echo "::set-env name=BV_PART::minor"
        else
          echo "::set-env name=BV_PART::patch"
        fi
    - name: add bumpversion/${{ env['BV_PART'] }} label
      uses: actions/github@v1.0.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        args: label bumpversion/${{ env['BV_PART'] }}
    - uses: actions/checkout@master
    - name: Prepare repository
      run: git checkout "${GITHUB_REF:11}"
    - name: Set up Python 3.7
      uses: actions/setup-python@v1
      with:
        python-version: 3.7
    - name: install bumpversion
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install bumpversion
    - name: set up git user
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    - name: run bumpversion ${{ env['BV_PART'] }}
      env:
        ISSUE_NUMBER: ${{ github.event.issue.number }}
        ISSUE_DESCRIPTION: ${{ github.event.issue.description }}
      run: |
        echo "bumpversion $BV_PART"
        echo "::set-env name=OLD_TAG::$(git describe --tags --abbrev=0)"
        bumpversion $BV_PART --message "Bump version: {current_version} → {new_version}

        Resolves #${ISSUE_NUMBER} via GitHub Actions."
        echo "::set-env name=NEW_TAG::$(git describe --tags --abbrev=0)"
        git tag -n99 -l $NEW_TAG
        echo "::set-env name=RELEASE_SUMMARY::Changes:\n$(git log --pretty=format:'%s' $OLD_TAG..HEAD -i -E --grep='^([a-z]*?):' | sed 's/^/  - /')"
        git tag $NEW_TAG $NEW_TAG^{} -f -m "This is a $BV_PART release.

        ${RELEASE_SUMMARY}"
        git tag -n99 -l $NEW_TAG
    - name: comment on issue
      uses: actions/github@v1.0.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        args: |
          comment "Creating a ${BV_PART} release from ${OLD_TAG} → ${NEW_TAG}.

          ${{ env['RELEASE_SUMMARY'] }}"
    - name: always fail
      run: |
        exit 1
    - name: push changes
      uses: ad-m/github-push-action@v0.5.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}

  always_job:
    name: Always run job
    runs-on: ubuntu-latest
    steps:
      - name: Always run
        run: echo "This job is used to prevent the workflow status from showing as failed when all other jobs are skipped. See https://github.community/t5/GitHub-Actions/Workflow-is-failing-if-no-job-can-be-ran-due-to-condition/m-p/38085 for more information."
